<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>FugthAI - Conversational AI Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        :root, html[data-theme="light"] {
            --bg-main: #f7f7f8;
            --bg-sidebar: #ffffff;
            --bg-input: #ffffff;
            --bg-menu: #ffffff;
            --bg-message-user: #e9e9eb;
            --bg-message-bot: #f7f7f8;
            --text-primary: #000000;
            --text-secondary: #575757;
            --accent: #1976d2;
            --danger: #d32f2f;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }
        html[data-theme="dark"] {
            --bg-main: #000000;
            --bg-sidebar: #111111;
            --bg-input: #111111;
            --bg-menu: #222222;
            --bg-message-user: #2a2a2a;
            --bg-message-bot: #111111;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #6ea8ff;
            --danger: #ff5252;
            --border-color: #333333;
            --shadow-color: rgba(255, 255, 255, 0.05);
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-primary);
        }
        .prose { color: var(--text-primary); }
        .prose code:not(pre *) { background-color: rgba(0,0,0,0.05); padding: 2px 5px; border-radius: 4px; font-family: 'Space Grotesk', monospace; }
        html[data-theme="dark"] .prose code:not(pre *) { background-color: rgba(255,255,255,0.1); }
        .prose pre { background-color: #282c34; padding: 1rem; border-radius: 0.5rem; }
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { color: var(--accent); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-sidebar); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        
        .chat-options-menu { position: absolute; z-index: 50; background-color: var(--bg-menu); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); padding: 4px; }
        
        .action-btn { opacity:0; transition:opacity .15s ease-in-out; }
        .message-container:hover .action-btn { opacity:1; }
        .feedback-btn.liked, .feedback-btn.disliked { color: var(--accent); }
        .feedback-btn.disliked { color: var(--danger); }

        /* Sidebar hover/slide styles */
        .sidebar { transition: width 0.3s ease-in-out, transform 0.3s ease-in-out; }

        @media (min-width: 768px) {
            #left-sidebar, #right-sidebar { width: 5rem; } /* Collapsed */
            #left-sidebar:hover, #right-sidebar:hover { width: 18rem; } /* Expanded */
            main { margin-left: 5rem; margin-right: 5rem; transition: margin 0.3s ease-in-out; }
            #left-sidebar:hover ~ main { margin-left: 18rem; }
            #right-sidebar:hover ~ main { margin-right: 18rem; }
            #left-sidebar:hover, #right-sidebar:hover { z-index: 25; }
            .sidebar-text, .sidebar-brand-text { opacity: 0; transition: opacity 0.2s 0.1s ease-in-out; white-space: nowrap; }
            #left-sidebar:hover .sidebar-text, #left-sidebar:hover .sidebar-brand-text { opacity: 1; }
            #right-sidebar:hover .sidebar-text { opacity: 1; }
        }

        @media (max-width: 767.98px) {
            .sidebar { position: fixed; top: 0; bottom: 0; z-index: 40; width: 18rem; }
            #left-sidebar { left: 0; transform: translateX(-100%); }
            #left-sidebar.open { transform: translateX(0); }
            #right-sidebar { right: 0; transform: translateX(100%); }
            #right-sidebar.open { transform: translateX(0); }
            #sidebar-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 30; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
            #sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden antialiased">
    <div id="sidebar-overlay"></div>
    <!-- Left Sidebar for Chat History -->
    <aside id="left-sidebar" class="bg-[var(--bg-sidebar)] p-4 flex flex-col border-r border-[var(--border-color)] flex-shrink-0">
        <div class="flex items-center mb-4 flex-shrink-0">
            <h1 class="text-xl font-bold font-['Space_Grotesk'] overflow-hidden">F<span class="sidebar-brand-text">ugth</span><span class="text-[var(--accent)] sidebar-brand-text">AI</span></h1>
            <button id="theme-btn" class="hover:bg-black/10 dark:hover:bg-white/10 p-2 rounded-full text-lg ml-auto">
                <i class="fa-solid fa-moon"></i>
            </button>
        </div>
        <div id="sidebar-content" class="flex flex-col flex-1 overflow-y-auto">
            <button id="new-chat-btn" class="w-full py-2 px-3 rounded-full bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10 mb-4 transition-colors text-sm flex items-center justify-center">
                <i class="fa-solid fa-plus mr-2"></i><span class="sidebar-text">New Chat</span>
            </button>
            <nav id="chat-list" class="flex-1 overflow-y-auto space-y-1"></nav>
        </div>
         <div class="pt-4 border-t border-[var(--border-color)] space-y-2 text-sm">
            <button id="import-chats-btn" class="w-full flex items-center py-2 px-3 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition-colors"><i class="fa-solid fa-file-import w-6 text-[var(--text-secondary)]"></i><span class="ml-2 sidebar-text">Import Chats</span></button>
            <input type="file" id="import-chats-input" class="hidden" accept=".json">
            <button id="export-chats-btn" class="w-full flex items-center py-2 px-3 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition-colors"><i class="fa-solid fa-file-export w-6 text-[var(--text-secondary)]"></i><span class="ml-2 sidebar-text">Export All Chats</span></button>
            <button id="help-btn" class="w-full flex items-center py-2 px-3 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition-colors"><i class="fa-solid fa-circle-question w-6 text-[var(--text-secondary)]"></i><span class="ml-2 sidebar-text">Help & FAQ</span></button>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col min-w-0 relative">
        <header class="p-3 flex justify-between items-center border-b border-[var(--border-color)] flex-shrink-0">
            <div class="flex items-center">
                <button id="toggle-left-sidebar" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 mr-2 md:hidden">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <h2 id="chat-title" class="font-semibold truncate text-lg">New Chat</h2>
            </div>
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <select id="model-switcher" class="bg-[var(--bg-input)] border border-[var(--border-color)] rounded-md py-1.5 px-3 text-sm appearance-none focus:outline-none focus:ring-1 focus:ring-[var(--accent)]">
                        <option value="lite">Fugth-1NDM-Lite</option>
                        <option value="high">Fugth-1NDM-HIGH</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-[var(--text-secondary)] pointer-events-none"></i>
                </div>
                <button id="toggle-right-sidebar" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10">
                    <i class="fa-solid fa-sliders"></i>
                </button>
            </div>
        </header>
        
        <div id="chat-history" class="flex-1 p-4 md:p-6 space-y-6 overflow-y-auto">
            <div id="welcome-message" class="text-center pt-20">
                <div class="inline-block p-4 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 mb-4">
                     <i class="fa-solid fa-brain text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold font-['Space_Grotesk']">How can I help you today?</h1>
            </div>
        </div>
        
        <footer class="p-4 flex-shrink-0 bg-transparent">
            <div class="max-w-4xl mx-auto">
                <div id="status-bar" class="h-5 mb-2 flex items-center gap-2 text-xs text-[var(--text-secondary)]">
                    <div id="status-dot" class="w-2 h-2 rounded-full"></div>
                    <span id="status-text"></span>
                </div>
                <div class="relative flex items-center bg-[var(--bg-input)] rounded-2xl shadow-lg border border-[var(--border-color)] focus-within:border-[var(--accent)] transition-all">
                    <button id="quick-prompts-btn" class="p-3 rounded-full hover:bg-black/5 dark:hover:bg-white/10" title="Quick Prompts">
                        <i class="fa-solid fa-wand-magic-sparkles text-[var(--text-secondary)]"></i>
                    </button>
                    <label for="file-input" class="p-3 rounded-full hover:bg-black/5 dark:hover:bg-white/10 cursor-pointer" title="Upload File">
                        <i class="fa-solid fa-paperclip text-[var(--text-secondary)]"></i>
                    </label>
                    <input type="file" id="file-input" class="hidden" accept=".txt,.js,.py,.html,.css,.json,.csv,.md">
                    
                    <textarea id="prompt-input" rows="1" class="w-full bg-transparent p-3 outline-none resize-none disabled:opacity-50" placeholder="Ask anything…" disabled></textarea>
                    
                    <button id="send-btn" class="p-3 rounded-full hover:bg-black/5 dark:hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                      <i class="fa-solid fa-arrow-up text-[var(--text-secondary)]"></i>
                    </button>
                </div>
            </div>
        </footer>
    </main>
  
    <aside id="right-sidebar" class="sidebar bg-[var(--bg-sidebar)] w-80 p-4 flex-col border-l border-[var(--border-color)] flex-shrink-0">
        <h3 class="font-bold text-lg font-['Space_Grotesk'] sidebar-text">Settings</h3>
        <div class="p-4 rounded-lg bg-black/5 dark:bg-white/5 sidebar-text">
            <h3 class="font-semibold text-[var(--text-primary)] mb-2">Persona</h3>
            <select id="persona-select" class="w-full bg-[var(--bg-input)] border border-[var(--border-color)] rounded-md p-2 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--accent)]"></select>
        </div>
        <div class="p-4 rounded-lg bg-black/5 dark:bg-white/5 sidebar-text">
            <h3 class="font-semibold text-[var(--text-primary)] mb-2">System Prompt</h3>
            <textarea id="system-prompt-input" rows="12" class="w-full bg-[var(--bg-input)] border border-[var(--border-color)] rounded-md p-2 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--accent)]"></textarea>
        </div>
        <button id="clear-history-btn" class="w-full py-2 px-3 rounded-full bg-red-500/10 hover:bg-red-500/20 text-red-400 transition-colors text-sm sidebar-text">
            <i class="fa-solid fa-trash-can mr-2"></i>Clear Chat History
        </button>
    </aside>

    <div id="quick-prompts-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
        <div class="bg-[var(--bg-menu)] p-6 rounded-xl border border-[var(--border-color)] shadow-lg w-full max-w-2xl relative">
            <button id="modal-close-x" class="absolute top-4 right-4 text-[var(--text-secondary)] hover:text-[var(--text-primary)] text-2xl font-bold">&times;</button>
            <h3 class="text-lg font-bold text-[var(--accent)] mb-4">Quick Prompts</h3>
            <div id="quick-prompts-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = sel => document.querySelector(sel);

    // --- 1. SETTINGS ---
    const HUGGING_FACE_URL = 'https://fugthchat-fugth-chat-ndm3-brain.hf.space';
    const MAX_CONTEXT_TOKENS = 800;
    const SIDEBAR_AUTO_CLOSE_DELAY = 7000;

    const PERSONAS = {
        default: { name: 'Default Assistant', prompt: 'I am a helpful, friendly, and versatile AI assistant named FugthAI. I can answer questions, provide explanations, and assist with a wide range of tasks.' },
        lawyer: { name: 'Lawyer', prompt: 'I am an AI Legal Advisor. My role is to provide information on legal topics, explain legal concepts, and help draft documents. I am strictly forbidden from providing medical, financial, or any other type of advice outside the legal domain. If a user asks for non-legal advice, I MUST refuse and state clearly: "My expertise is strictly limited to legal matters. I cannot provide advice on that topic."' },
        dentist: { name: 'Dentist', prompt: 'I am an AI Dental Advisor. My purpose is to provide information about dental health, oral hygiene, and common dental procedures. I am not a substitute for a real medical professional. I am strictly forbidden from providing advice on any topic outside of dentistry and general oral health. If asked a non-dental question, I MUST refuse and state clearly: "I can only provide information about dental health. For other topics, please consult an appropriate expert."' },
        sales: { name: 'Sales Expert', prompt: 'I am a master AI Sales Expert. My goal is to provide users with world-class sales strategies, pitch advice, negotiation tactics, and motivational coaching. I must remain in the persona of a confident, persuasive, and highly knowledgeable sales leader. I am strictly forbidden from engaging in topics outside of sales, marketing, and business development. If asked to, I MUST refuse and pivot back, stating: "That\'s outside my area of expertise, which is sales. Let\'s focus on how we can crush your sales goals."' }
    };

    const QUICK_PROMPTS = [
        { title: "Explain Something", prompt: "Explain the concept of [topic] in simple terms." },
        { title: "Write a Poem", prompt: "Write a short poem about [subject]." },
        { title: "Brainstorm Ideas", prompt: "Brainstorm 5 ideas for a new project about [topic]." },
        { title: "Summarize Text", prompt: "Summarize the following text for me: [paste text here]." },
        { title: "Translate to French", prompt: "Translate the following sentence to French: " },
        { title: "Create a Recipe", prompt: "Give me a simple recipe for [dish]." }
    ];
    
    let state = {
        chats: JSON.parse(localStorage.getItem('fugthai_chats_v15') || '[]'),
        activeChatId: null,
        isGenerating: false,
        abortController: null,
        theme: localStorage.getItem('fugthai_theme_v15') || 'light',
        activeMenuChatId: null,
        sidebarCloseTimer: null,
    };

    const el = {
        leftSidebar: $('#left-sidebar'),
        rightSidebar: $('#right-sidebar'),
        toggleLeftSidebar: $('#toggle-left-sidebar'),
        toggleRightSidebar: $('#toggle-right-sidebar'),
        chatHistory: $('#chat-history'),
        chatList: $('#chat-list'),
        chatTitle: $('#chat-title'),
        promptInput: $('#prompt-input'),
        sendBtn: $('#send-btn'),
        fileInput: $('#file-input'),
        modelSwitcher: $('#model-switcher'),
        statusBar: $('#status-bar'),
        statusText: $('#status-text'),
        statusDot: $('#status-dot'),
        newChatBtn: $('#new-chat-btn'),
        clearHistoryBtn: $('#clear-history-btn'),
        welcomeMessage: $('#welcome-message'),
        personaSelect: $('#persona-select'),
        systemPromptInput: $('#system-prompt-input'),
        themeBtn: $('#theme-btn'),
        importChatsBtn: $('#import-chats-btn'),
        importChatsInput: $('#import-chats-input'),
        exportChatsBtn: $('#export-chats-btn'),
        helpBtn: $('#help-btn'),
        sidebarOverlay: $('#sidebar-overlay'),
        quickPromptsBtn: $('#quick-prompts-btn'),
        quickPromptsModal: $('#quick-prompts-modal'),
        quickPromptsList: $('#quick-prompts-list'),
        modalCloseX: $('#modal-close-x'),
    };
    
    function init() {
        Object.keys(PERSONAS).forEach(key => el.personaSelect.add(new Option(PERSONAS[key].name, key)));
        el.personaSelect.add(new Option("Custom", "custom"));
        QUICK_PROMPTS.forEach(p => {
            const card = document.createElement('div');
            card.className = 'p-4 bg-black/5 dark:bg-white/10 rounded-lg hover:bg-black/10 dark:hover:bg-white/20 cursor-pointer transition-colors';
            card.innerHTML = `<h4 class="font-bold text-sm text-[var(--accent)]">${p.title}</h4><p class="text-xs text-[var(--text-secondary)]">${p.prompt}</p>`;
            card.onclick = () => {
                el.promptInput.value = p.prompt;
                el.quickPromptsModal.classList.add('hidden');
                el.promptInput.focus();
                autoResizeTextarea();
            };
            el.quickPromptsList.appendChild(card);
        });
        
        if (state.chats.length === 0) createNewChat();
        state.activeChatId = state.activeChatId || state.chats[0]?.id;
        
        applyTheme();
        renderChatList();
        selectChat(state.activeChatId);
        addEventListeners();
        checkServerStatus();
    }

    function saveChats() { localStorage.setItem('fugthai_chats_v15', JSON.stringify(state.chats)); }
    
    function createNewChat() {
        const newChat = { 
            id: Date.now(), 
            name: 'New Chat', 
            history: [], 
            persona: 'default', 
            system_prompt: PERSONAS['default'].prompt,
            pinned: false,
        };
        state.chats.unshift(newChat);
        saveChats();
        return newChat;
    }

    function applyTheme() {
        document.documentElement.setAttribute('data-theme', state.theme);
        localStorage.setItem('fugthai_theme_v15', state.theme);
        el.themeBtn.innerHTML = state.theme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    }

    function renderChatList() {
        const sortedChats = [...state.chats].sort((a, b) => {
            if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
            return b.id - a.id;
        });

        el.chatList.innerHTML = '';
        sortedChats.forEach(c => {
            const div = document.createElement('div');
            div.className = `chat-item group relative flex items-center p-2 rounded-lg cursor-pointer transition-colors ${c.id === state.activeChatId ? 'bg-black/10 dark:bg-white/10' : 'hover:bg-black/5 dark:hover:bg-white/5'}`;
            div.dataset.chatId = c.id;
            const pinIcon = c.pinned ? `<i class="fa-solid fa-thumbtack text-[var(--accent)] text-xs w-6 text-center"></i>` : `<i class="fa-regular fa-message w-6 text-center text-[var(--text-secondary)]"></i>`;
            div.innerHTML = `<div class="w-6 text-center">${pinIcon}</div><span class="ml-1 flex-grow truncate text-sm sidebar-text">${c.name}</span><button data-action="toggle-menu" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full text-transparent group-hover:text-[var(--text-secondary)] hover:bg-black/10 dark:hover:bg-white/10 sidebar-text"><i class="fa-solid fa-ellipsis-h"></i></button>`;
            el.chatList.appendChild(div);
        });
    }

    function selectChat(id) {
        if (!id && state.chats.length > 0) id = state.chats[0].id;
        if (!id) return;
        state.activeChatId = id;
        renderChatList();
        const chat = state.chats.find(c => c.id === id);
        if (chat) {
            el.chatTitle.textContent = chat.name;
            el.systemPromptInput.value = chat.system_prompt;
            el.personaSelect.value = chat.persona || 'custom';
            el.chatHistory.innerHTML = '';
            el.welcomeMessage.classList.toggle('hidden', chat.history.length > 0);
            chat.history.forEach((m, i) => addMessage(m.role, m.text, m, false));
            scrollToBottom();
        }
    }
    
    async function typeWriter(element, text) {
        return new Promise(resolve => {
            let i = 0;
            const speed = 15;
            const cursor = element.querySelector('.blinking-cursor');
            function type() {
                if (i < text.length && state.isGenerating) {
                    element.querySelector('.text-content').innerHTML = marked.parse(text.substring(0, i + 1));
                    i++;
                    setTimeout(type, speed);
                    scrollToBottom();
                } else {
                    if (cursor) cursor.style.display = 'none';
                    element.querySelectorAll('pre code').forEach(block => hljs.highlightBlock(block));
                    resolve();
                }
            }
            type();
        });
    }
    
    function addMessage(role, text, options = {}, save = true, isTyping = false) {
        const { isError = false, feedback = null, index = -1, duration = null } = options;
        el.welcomeMessage.classList.add('hidden');
        const activeChat = state.chats.find(c => c.id === state.activeChatId);
        if (!activeChat) return;
        const who = role === 'user' ? 'You' : 'FugthAI';
        const avatarIcon = role === 'user' ? 'fa-user' : 'fa-brain';
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container flex items-start gap-4';
        const avatar = `<div class="w-8 h-8 rounded-full bg-black/5 dark:bg-white/10 flex items-center justify-center text-lg text-[var(--text-secondary)] flex-shrink-0 mt-1"><i class="fa-solid ${avatarIcon}"></i></div>`;
        const bubble = document.createElement('div');
        bubble.className = 'flex-1';
        
        let actionsHTML = '';
        if (role === 'assistant' && !isError && !isTyping) {
            actionsHTML = `
                <div class="flex items-center gap-2 mt-2 text-xs text-[var(--text-secondary)]">
                    ${duration ? `<span>${(duration / 1000).toFixed(1)}s</span>` : ''}
                    <button data-action="regenerate" data-index="${index}" class="action-btn p-1 hover:text-[var(--text-primary)]" title="Regenerate"><i class="fa-solid fa-arrows-rotate"></i></button>
                    <button data-action="like" data-index="${index}" class="action-btn feedback-btn p-1 hover:text-[var(--text-primary)] ${feedback === 'liked' ? 'liked' : ''}" title="Like"><i class="fa-regular fa-thumbs-up"></i></button>
                    <button data-action="dislike" data-index="${index}" class="action-btn feedback-btn p-1 hover:text-[var(--text-primary)] ${feedback === 'disliked' ? 'disliked' : ''}" title="Dislike"><i class="fa-regular fa-thumbs-down"></i></button>
                </div>
            `;
        }

        bubble.innerHTML = `
            <strong class="text-sm font-semibold">${who}</strong>
            <div class="prose max-w-none text-content">${isTyping ? '' : marked.parse(text)}</div>
            ${isTyping ? '<span class="blinking-cursor">▍</span>' : ''}
            ${actionsHTML}
        `;
        messageContainer.innerHTML = `${avatar}${bubble.outerHTML}`;
        el.chatHistory.appendChild(messageContainer);
        scrollToBottom();

        if (save && !isError) {
            const messageToSave = { role, text, duration, feedback: null };
            activeChat.history.push(messageToSave);
            saveChats();
        }
        return messageContainer;
    }

    function buildPrompt() { /* Unchanged */ }
    
    function scrollToBottom() { el.chatHistory.scrollTop = el.chatHistory.scrollHeight; }

    async function checkServerStatus() { /* Unchanged */ }
    
    function setGenerating(on) { /* Unchanged */ }
    
    async function getAiResponse() {
        setGenerating(true);
        const startTime = Date.now();
        state.abortController = new AbortController();
        const prompt = buildPrompt();
        const modelQuality = el.modelSwitcher.value;
        const assistantMessageElement = addMessage('assistant', '', false, false, true);
        const textContentElement = assistantMessageElement.querySelector('.text-content');
        
        try {
            const res = await fetch(`${HUGGING_FACE_URL}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt, quality: modelQuality }),
                signal: state.abortController.signal
            });
            if (!res.ok) throw new Error(`Request failed with status ${res.status}`);
            const data = await res.json();

            if (state.isGenerating) {
                const duration = Date.now() - startTime;
                await typeWriter(assistantMessageElement, data.response);
                
                const activeChat = state.chats.find(c => c.id === state.activeChatId);
                if(activeChat) {
                    const newMessage = { role: 'assistant', text: data.response, duration: duration, feedback: null };
                    activeChat.history.push(newMessage);
                    saveChats();
                    selectChat(state.activeChatId); // Re-render to show action buttons
                }
            }
        } catch (e) {
            const errorMessage = e.name === 'AbortError' ? 'Request cancelled.' : `An error occurred: ${e.message}. Please try again.`;
            textContentElement.textContent = errorMessage;
            assistantMessageElement.classList.add('text-red-400');
        } finally {
            if (state.isGenerating) {
                setGenerating(false);
            }
        }
    }

    function autoResizeTextarea() { /* Unchanged */ }
    
    function updateStatus(status, text) { /* Unchanged */ }

    async function handleSend() {
        if (window.innerWidth < 768 && el.leftSidebar.classList.contains('open')) {
            clearTimeout(state.sidebarCloseTimer);
            state.sidebarCloseTimer = setTimeout(() => {
                el.leftSidebar.classList.remove('open');
                el.sidebarOverlay.classList.remove('open');
            }, SIDEBAR_AUTO_CLOSE_DELAY);
        }

        const promptText = el.promptInput.value.trim();
        if (!promptText || state.isGenerating) return;
        addMessage('user', promptText, {}, true);
        const activeChat = state.chats.find(c => c.id === state.activeChatId);
        if (activeChat.name === 'New Chat' && activeChat.history.length === 1) {
            activeChat.name = promptText.substring(0, 40) + (promptText.length > 40 ? '...' : '');
            saveChats();
            renderChatList();
            el.chatTitle.textContent = activeChat.name;
        }
        el.promptInput.value = '';
        autoResizeTextarea();
        getAiResponse();
    }
    
    function handleFileUpload(event) { /* Unchanged */ }

    function toggleChatOptionsMenu(chatId, buttonEl) { /* Unchanged */ }

    function closeAllMenus() { /* Unchanged */ }

    function addEventListeners() {
        el.sendBtn.onclick = () => {
             if (state.isGenerating) { state.abortController?.abort(); setGenerating(false); } 
             else { handleSend(); }
        };
        el.promptInput.addEventListener('input', autoResizeTextarea);
        el.promptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }});
        el.fileInput.addEventListener('change', handleFileUpload);
        el.themeBtn.onclick = () => { state.theme = state.theme === 'dark' ? 'light' : 'dark'; applyTheme(); };
        el.newChatBtn.onclick = () => { const newChat = createNewChat(); selectChat(newChat.id); };
        
        el.chatHistory.addEventListener('click', e => {
            const button = e.target.closest('[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const index = parseInt(button.dataset.index, 10);
            
            if (action === 'regenerate') {
                const chat = state.chats.find(c => c.id === state.activeChatId);
                if (chat) {
                    chat.history = chat.history.slice(0, index); // Trim history to before this message
                    saveChats();
                    selectChat(state.activeChatId); // Re-render chat
                    getAiResponse(); // Get new response
                }
            } else if (action === 'like' || action === 'dislike') {
                const chat = state.chats.find(c => c.id === state.activeChatId);
                if (chat && chat.history[index]) {
                    const message = chat.history[index];
                    message.feedback = message.feedback === action ? null : action;
                    saveChats();
                    selectChat(state.activeChatId); // Re-render to show updated feedback state
                }
            }
        });

        el.chatList.addEventListener('click', e => {
            const chatItem = e.target.closest('.chat-item');
            if (!chatItem) return;
            const menuButton = e.target.closest('[data-action="toggle-menu"]');
            if (menuButton) {
                e.stopPropagation();
                const chatId = parseInt(chatItem.dataset.chatId);
                if (state.activeMenuChatId === chatId) closeAllMenus();
                else toggleChatOptionsMenu(chatId, menuButton);
            } else {
                selectChat(parseInt(chatItem.dataset.chatId));
                if (window.innerWidth < 768) {
                    el.leftSidebar.classList.remove('open');
                    el.sidebarOverlay.classList.remove('open');
                }
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.chat-options-menu') && !e.target.closest('[data-action="toggle-menu"]')) closeAllMenus();
            const actionButton = e.target.closest('.chat-options-menu button');
            if (!actionButton) return;
            const action = actionButton.dataset.action;
            const chatId = state.activeMenuChatId;
            const chat = state.chats.find(c => c.id === chatId);
            if (!chat) return;
            switch(action) {
                case 'pin': chat.pinned = !chat.pinned; saveChats(); renderChatList(); break;
                case 'rename':
                     const newName = prompt('Enter new chat name:', chat.name);
                     if (newName && newName.trim()) { chat.name = newName.trim(); saveChats(); renderChatList(); if (chat.id === state.activeChatId) el.chatTitle.textContent = newName.trim(); }
                    break;
                case 'share': navigator.clipboard.writeText(`${window.location.origin}/chat/${chatId}`).then(() => alert('Share link copied! (Feature demo)')).catch(err => console.error('Failed to copy', err)); break;
                case 'delete':
                    if (confirm('Are you sure you want to delete this chat?')) {
                        state.chats = state.chats.filter(c => c.id !== chatId);
                        saveChats();
                        if (state.activeChatId === chatId) selectChat(state.chats[0]?.id || null);
                        renderChatList();
                    }
                    break;
            }
            closeAllMenus();
        });

        el.clearHistoryBtn.onclick = () => {
            if (!state.activeChatId) return;
            if (confirm('Are you sure you want to clear the history for this chat?')) {
                const chat = state.chats.find(c => c.id === state.activeChatId);
                if (chat) { chat.history = []; saveChats(); selectChat(state.activeChatId); }
            }
        };

        el.systemPromptInput.oninput = () => {
            const chat = state.chats.find(c => c.id === state.activeChatId);
            if(chat) { chat.system_prompt = el.systemPromptInput.value; chat.persona = 'custom'; el.personaSelect.value = 'custom'; saveChats(); }
        };
        
        el.personaSelect.onchange = () => {
            const personaKey = el.personaSelect.value;
            const chat = state.chats.find(c => c.id === state.activeChatId);
            if(chat && personaKey !== 'custom') { chat.persona = personaKey; chat.system_prompt = PERSONAS[personaKey].prompt; el.systemPromptInput.value = chat.system_prompt; saveChats(); }
        };

        el.toggleLeftSidebar.onclick = () => {
            el.leftSidebar.classList.add('open');
            el.sidebarOverlay.classList.add('open');
        };
        el.sidebarOverlay.onclick = () => {
            el.leftSidebar.classList.remove('open');
            el.sidebarOverlay.classList.remove('open');
            el.rightSidebar.classList.remove('open');
        };

        el.toggleRightSidebar.onclick = () => {
            el.rightSidebar.classList.add('open');
            el.sidebarOverlay.classList.add('open');
        };

        el.quickPromptsBtn.onclick = () => el.quickPromptsModal.classList.remove('hidden');
        el.modalCloseX.onclick = () => el.quickPromptsModal.classList.add('hidden');
        el.quickPromptsModal.onclick = (e) => { if (e.target === el.quickPromptsModal) el.quickPromptsModal.classList.add('hidden'); };

        el.importChatsBtn.onclick = () => el.importChatsInput.click();
        el.importChatsInput.onchange = (e) => { /* unchanged */ };
        el.exportChatsBtn.onclick = () => { /* unchanged */ };
        el.helpBtn.onclick = () => { /* unchanged */ };
    }
    
    init();
});
</script>
</body>
</html>
