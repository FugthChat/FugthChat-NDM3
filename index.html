<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>FugthAI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/nord.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
      :root {
        --bg0:#2E3440;--bg1:#3B4252;--bg2:#434C5E;--bg3:#4C566A;
        --fg0:#ECEFF4;--fg1:#D8DEE9;--accent:#88C0D0;
        --accent-hover:#8FBCBB;--accent-text:#2E3440;--danger:#BF616A;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      html[data-theme="light"] {
        --bg0:#fdf6e3;--bg1:#eee8d5;--bg2:#d8d1c1;--bg3:#c9c2b2;
        --fg0:#586e75;--fg1:#657b83;--accent:#268bd2;
        --accent-hover:#1a6d9f;--accent-text:#fdf6e3;--danger:#dc322f;
      }
      body { font-family: 'Inter', sans-serif; background:var(--bg0); color:var(--fg0); }
      .sidebar { transition: width 0.3s ease-in-out; }
      .sidebar-item:hover, .sidebar-item.active { background:var(--bg2); }
      .action-btn { opacity:0; transition:opacity .15s ease-in-out; }
      .message-container:hover .action-btn { opacity:1; }
      #context-menu { position: absolute; z-index: 100; background-color: var(--bg1); border: 1px solid var(--bg2); border-radius: 8px; box-shadow: var(--shadow); padding: 8px; display: none; }
      #context-menu button { display: block; width: 100%; text-align: left; padding: 8px 12px; border-radius: 4px; background: none; border: none; color: var(--fg0); cursor: pointer; }
      #context-menu button:hover { background-color: var(--bg2); }
      .prose { color: var(--fg0); }
      .prose h1, .prose h2, .prose h3, .prose h4, .prose strong { color: var(--fg0); }
      .prose a { color: var(--accent); }
      .prose blockquote { border-left-color: var(--accent); }
      .prose pre { background-color: #232731; padding: 1rem; border-radius: 0.5rem; color: #d8dee9; font-size: 0.875rem; }
      .prose code { font-family: 'Courier New', Courier, monospace; background-color: var(--bg2); padding: 2px 4px; border-radius: 4px; }
      .prose pre code { background-color: transparent; padding: 0; border-radius: 0; }
      .feedback-btn.liked { color: var(--accent); }
      .feedback-btn.disliked { color: var(--danger); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

  <aside id="left-sidebar" class="sidebar w-72 bg-[var(--bg1)] p-4 flex flex-col border-r border-[var(--bg2)] flex-shrink-0">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-xl font-bold">Fugth<span class="text-[var(--accent)]">AI</span></h1>
      <button id="theme-btn" class="hover:bg-[var(--bg2)] p-2 rounded">ðŸŒ™</button>
    </div>
    <div id="sidebar-content" class="flex flex-col flex-1 overflow-y-auto">
        <button id="new-chat-btn" class="w-full py-2 rounded bg-[var(--bg2)] hover:bg-[#5E81AC] mb-4 transition-colors text-sm">
          <i class="fa-solid fa-plus mr-2"></i>New Chat
        </button>
        <div class="flex items-center bg-[var(--bg0)] rounded p-2 mb-4">
            <i class="fa-solid fa-search text-[var(--fg1)] mr-2"></i>
            <input id="search-chats-input" class="bg-transparent flex-1 outline-none text-sm" placeholder="Search chatsâ€¦"/>
        </div>
        <nav id="chat-list" class="flex-1 overflow-y-auto space-y-2 pr-1 -mr-1"></nav>
    </div>
    <div class="pt-4 border-t border-[var(--bg2)] space-y-2 text-sm">
      <button id="import-chats-btn" class="w-full flex items-center py-2 px-3 rounded hover:bg-[var(--bg2)] transition-colors"><i class="fa-solid fa-file-import w-6"></i><span class="ml-2">Import Chats</span></button>
      <input type="file" id="import-chats-input" class="hidden" accept=".json">
      <button id="export-chats-btn" class="w-full flex items-center py-2 px-3 rounded hover:bg-[var(--bg2)] transition-colors"><i class="fa-solid fa-file-export w-6"></i><span class="ml-2">Export All Chats</span></button>
      <button id="help-btn" class="w-full flex items-center py-2 px-3 rounded hover:bg-[var(--bg2)] transition-colors"><i class="fa-solid fa-circle-question w-6"></i><span class="ml-2">Help</span></button>
    </div>
  </aside>

  <main class="flex-1 flex flex-col min-w-0">
    <header class="p-4 flex justify-between items-center border-b border-[var(--bg2)] flex-shrink-0">
        <div class="flex items-center">
            <button id="toggle-left-sidebar" class="p-2 rounded-md hover:bg-[var(--bg2)] mr-2">
                <i class="fa-solid fa-bars"></i>
            </button>
            <h2 id="chat-title" class="font-semibold truncate"></h2>
        </div>
        <div class="flex items-center space-x-2">
            <button id="clear-history-btn" class="p-2 rounded-md hover:bg-[var(--bg2)]" title="Clear chat history">
                <i class="fa-solid fa-broom"></i>
            </button>
            <button id="toggle-right-sidebar" class="p-2 rounded-md hover:bg-[var(--bg2)] lg:hidden">
                <i class="fa-solid fa-sliders"></i>
            </button>
        </div>
    </header>
    
    <div id="chat-history" class="flex-1 p-6 space-y-6 overflow-y-auto"></div>
    
    <footer class="p-4 flex-shrink-0 bg-[var(--bg0)]">
      <div id="status-bar" class="h-5 mb-2 flex items-center gap-2 text-xs">
        <div id="status-dot" class="w-2 h-2 rounded-full"></div><span id="status-text"></span>
      </div>
      <div class="relative">
        <button id="quick-prompts-btn" class="absolute bottom-3.5 left-3.5 w-10 h-10 rounded-full bg-[var(--bg2)] hover:bg-[var(--bg3)] text-[var(--fg0)] flex items-center justify-center transition-colors" title="Quick Prompts">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>
        <textarea id="prompt-input" rows="1" class="w-full bg-[var(--bg2)] rounded-lg p-4 pl-16 pr-16 outline-none resize-none transition-all duration-200 focus:ring-2 focus:ring-[var(--accent)] disabled:opacity-50" placeholder="Ask anythingâ€¦" disabled></textarea>
        <button id="send-btn" class="absolute bottom-3.5 right-3.5 w-10 h-10 rounded-full bg-[var(--accent)] text-[var(--accent-text)] disabled:bg-[var(--bg2)] disabled:cursor-not-allowed flex items-center justify-center transition-colors" disabled>
          <i class="fa-solid fa-arrow-up"></i>
        </button>
      </div>
    </footer>
  </main>
  
  <aside id="right-sidebar" class="sidebar lg:w-80 bg-[var(--bg1)] p-4 flex-col border-l border-[var(--bg2)] flex-shrink-0 space-y-4 overflow-y-auto hidden lg:flex">
      <div class="p-4 rounded-lg bg-[var(--bg1)] border border-[var(--bg2)]">
          <h3 class="font-bold text-[var(--accent)] mb-2">Model</h3>
          <select id="model-select" class="w-full bg-[var(--bg0)] border border-[var(--bg2)] rounded p-2 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--accent)]">
              <option value="Fugth-1.4NDM-Lite">Fugth-1.4NDM-Lite</option>
              <option value="Fugth-1.3NDM-HIGH">Fugth-1.3NDM-HIGH</option>
          </select>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg1)] border border-[var(--bg2)]">
          <h3 class="font-bold text-[var(--accent)] mb-2">Persona</h3>
          <select id="persona-select" class="w-full bg-[var(--bg0)] border border-[var(--bg2)] rounded p-2 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--accent)]"></select>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg1)] border border-[var(--bg2)]">
          <h3 class="font-bold text-[var(--accent)] mb-2">System Prompt</h3>
          <textarea id="system-prompt-input" rows="12" class="w-full bg-[var(--bg0)] rounded p-2 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--accent)]"></textarea>
      </div>
  </aside>

  <div id="context-menu">
      <button id="rename-chat"><i class="fa-solid fa-pen-to-square fa-fw mr-2"></i>Rename</button>
      <button id="delete-chat"><i class="fa-solid fa-trash-can fa-fw mr-2 text-red-500"></i>Delete</button>
  </div>
  
  <div id="quick-prompts-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="bg-[var(--bg1)] p-6 rounded-xl border border-[var(--bg2)] shadow-lg w-full max-w-2xl relative">
      <button id="modal-close-x" class="absolute top-4 right-4 text-[var(--fg1)] hover:text-[var(--fg0)] text-2xl font-bold">&times;</button>
      <h3 class="text-lg font-bold text-[var(--accent)] mb-4">Quick Prompts</h3>
      <div id="quick-prompts-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto">
        </div>
    </div>
  </div>
  
<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = sel => document.querySelector(sel);

    const HUGGING_FACE_URL = 'https://fugthchat-fugth-chat-ndm3-brain.hf.space';

    const PERSONAS = {
        default: { name: 'Default Assistant', prompt: 'You are a helpful, friendly, and versatile AI assistant named FugthAI. You provide clear, concise, and direct answers.' },
        lawyer: { name: 'Lawyer', prompt: 'You are an AI Legal Advisor. Your role is to provide information on legal topics, explain legal concepts, and help draft documents. You are strictly forbidden from providing medical, financial, or any other type of advice outside the legal domain. If a user asks for non-legal advice, you MUST refuse and state clearly: "My expertise is strictly limited to legal matters. I cannot provide advice on that topic."' },
        dentist: { name: 'Dentist', prompt: 'You are an AI Dental Advisor. Your purpose is to provide information about dental health, oral hygiene, and common dental procedures. You are not a substitute for a real medical professional. You are strictly forbidden from providing advice on any topic outside of dentistry and general oral health. If asked a non-dental question, you MUST refuse and state clearly: "I can only provide information about dental health. For other topics, please consult an appropriate expert."' },
        sales: { name: 'Sales Expert', prompt: 'You are a master AI Sales Expert. Your goal is to provide users with world-class sales strategies, pitch advice, negotiation tactics, and motivational coaching. You must remain in the persona of a confident, persuasive, and highly knowledgeable sales leader. You are strictly forbidden from engaging in topics outside of sales, marketing, and business development. If asked to, you MUST refuse and pivot back, stating: "That\'s outside my area of expertise, which is sales. Let\'s focus on how we can crush your sales goals."' }
    };
    
    const QUICK_PROMPTS = [
        { title: "Explain Something", prompt: "Explain the concept of [topic] in simple terms." },
        { title: "Write a Poem", prompt: "Write a short poem about [subject]." },
        { title: "Brainstorm Ideas", prompt: "Brainstorm 5 ideas for a new project about [topic]." },
        { title: "Summarize Text", prompt: "Summarize the following text for me: [paste text here]." },
        { title: "Translate to French", prompt: "Translate the following sentence to French: " },
        { title: "Create a Recipe", prompt: "Give me a simple recipe for [dish]." }
    ];

    let state = {
        chats: JSON.parse(localStorage.getItem('fugthai_chats_v11') || '[]'),
        activeChatId: null,
        isGenerating: false,
        abortController: null,
        theme: localStorage.getItem('fugthai_theme_v11') || 'dark',
        generationTimer: null
    };

    const el = {
        chatList: $('#chat-list'), chatTitle: $('#chat-title'), chatHistory: $('#chat-history'),
        promptInput: $('#prompt-input'), sendBtn: $('#send-btn'), newChatBtn: $('#new-chat-btn'),
        statusBar: $('#status-bar'), statusText: $('#status-text'), statusDot: $('#status-dot'),
        searchInput: $('#search-chats-input'), systemPromptInput: $('#system-prompt-input'),
        themeBtn: $('#theme-btn'), contextMenu: $('#context-menu'), renameChatBtn: $('#rename-chat'),
        deleteChatBtn: $('#delete-chat'), leftSidebar: $('#left-sidebar'), rightSidebar: $('#right-sidebar'),
        toggleLeftSidebar: $('#toggle-left-sidebar'), toggleRightSidebar: $('#toggle-right-sidebar'),
        sidebarContent: $('#sidebar-content'), exportChatsBtn: $('#export-chats-btn'),
        importChatsBtn: $('#import-chats-btn'), importChatsInput: $('#import-chats-input'),
        helpBtn: $('#help-btn'), clearHistoryBtn: $('#clear-history-btn'), personaSelect: $('#persona-select'),
        quickPromptsBtn: $('#quick-prompts-btn'), quickPromptsModal: $('#quick-prompts-modal'),
        quickPromptsList: $('#quick-prompts-list'), modalCloseX: $('#modal-close-x'), modelSelect: $('#model-select')
    };
    
    function init() {
        Object.keys(PERSONAS).forEach(key => { el.personaSelect.add(new Option(PERSONAS[key].name, key)); });
        el.personaSelect.add(new Option("Custom", "custom"));
        QUICK_PROMPTS.forEach(p => {
            const card = document.createElement('div');
            card.className = 'p-4 bg-[var(--bg2)] rounded-lg hover:bg-[var(--bg3)] cursor-pointer transition-colors';
            card.innerHTML = `<h4 class="font-bold text-sm text-[var(--accent)]">${p.title}</h4><p class="text-xs text-[var(--fg1)]">${p.prompt}</p>`;
            card.onclick = () => {
                el.promptInput.value = p.prompt;
                el.quickPromptsModal.classList.add('hidden');
                el.promptInput.focus();
                autoResizeTextarea();
            };
            el.quickPromptsList.appendChild(card);
        });

        if (state.chats.length === 0) createNewChat();
        state.activeChatId = state.activeChatId || state.chats[0].id;
        
        applyTheme();
        renderChatList();
        selectChat(state.activeChatId);
        
        addEventListeners();
        autoResizeTextarea();
        checkServerStatus();
    }

    function saveChats() { localStorage.setItem('fugthai_chats_v11', JSON.stringify(state.chats)); }
    
    function createNewChat() {
        const defaultPersona = 'default';
        const c = { id: Date.now(), name: 'New Chat', history: [], persona: defaultPersona, system_prompt: PERSONAS[defaultPersona].prompt, model: 'Fugth-1.4NDM-Lite' };
        state.chats.unshift(c);
        saveChats();
        return c;
    }

    function applyTheme() {
        document.documentElement.setAttribute('data-theme', state.theme);
        localStorage.setItem('fugthai_theme_v11', state.theme);
        el.themeBtn.innerHTML = state.theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    }

    function renderChatList(filter = '') {
        el.chatList.innerHTML = '';
        const filtered = state.chats.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
        filtered.forEach(c => {
            const div = document.createElement('div');
            div.className = `sidebar-item flex items-center p-2 rounded cursor-pointer transition-colors ${c.id === state.activeChatId ? 'active' : ''}`;
            div.innerHTML = `<i class="fa-regular fa-message w-6 text-center"></i><span class="ml-3 flex-grow truncate text-sm">${c.name}</span>`;
            div.dataset.chatId = c.id;
            el.chatList.appendChild(div);
        });
    }

    function selectChat(id) {
        if (!id && state.chats.length > 0) id = state.chats[0].id;
        else if (!id) id = createNewChat().id;

        state.activeChatId = id;
        renderChatList(el.searchInput.value);
        const chat = state.chats.find(c => c.id === id);
        
        if (chat) {
            el.chatTitle.textContent = chat.name;
            el.systemPromptInput.value = chat.system_prompt;
            el.personaSelect.value = chat.persona || 'custom';
            el.modelSelect.value = chat.model || 'Fugth-1.4NDM-Lite';
            el.chatHistory.innerHTML = '';
            chat.history.forEach((m, index) => addMessage(m.role, m.text, { ...m, index }, false));
            scrollToBottom();
        }
    }
    
    function addMessage(role, text, options = {}, save = true) {
        const { isError = false, feedback = null, index = -1, duration = null } = options;
        const activeChat = state.chats.find(c => c.id === state.activeChatId);
        if (!activeChat) return;

        const who = role === 'user' ? 'You' : (isError ? 'System' : PERSONAS[activeChat.persona]?.name || 'Assistant');
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        
        const messageInner = document.createElement('div');
        messageInner.className = 'flex items-start gap-4';
        
        const avatarColor = isError ? 'bg-[var(--danger)]' : role === 'user' ? 'bg-[var(--accent)]' : 'bg-[#A3BE8C]';
        const avatar = `<div class="w-10 h-10 rounded-full ${avatarColor} flex items-center justify-center text-xl font-bold text-[var(--accent-text)] flex-shrink-0">${who[0]}</div>`;
        
        const bubble = document.createElement('div');
        bubble.className = 'bg-[var(--bg1)] p-4 rounded-lg relative group max-w-2xl w-full';
        
        const textContentDiv = document.createElement('div');
        textContentDiv.className = 'text-base break-words prose';
        textContentDiv.innerHTML = marked.parse(text);
        
        textContentDiv.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'flex justify-between items-center mb-2';
        headerDiv.innerHTML = `<strong class="text-sm text-[var(--fg0)]">${who}</strong>`;

        if (role === 'assistant' && duration) {
            const timerDiv = document.createElement('span');
            timerDiv.className = 'text-xs text-[var(--fg1)]';
            timerDiv.innerHTML = `<i class="fa-regular fa-clock fa-fw mr-1"></i>${(duration / 1000).toFixed(2)}s`;
            headerDiv.appendChild(timerDiv);
        }

        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'absolute top-2 right-2 flex items-center space-x-1';

        if (role === 'assistant' && !isError) {
            const regenBtn = document.createElement('button');
            regenBtn.className = 'action-btn p-1.5 rounded-md hover:bg-[var(--bg3)] transition-all';
            regenBtn.title = 'Regenerate';
            regenBtn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i>';
            regenBtn.onclick = (e) => { e.stopPropagation(); handleRegenerate(index); };
            actionsContainer.appendChild(regenBtn);

            const likeBtn = document.createElement('button');
            likeBtn.className = `action-btn feedback-btn p-1.5 rounded-md hover:bg-[var(--bg3)] transition-all ${feedback === 'liked' ? 'liked' : ''}`;
            likeBtn.title = 'Like';
            likeBtn.innerHTML = '<i class="fa-regular fa-thumbs-up"></i>';
            likeBtn.onclick = (e) => { e.stopPropagation(); handleFeedback(index, 'liked', likeBtn, dislikeBtn); };
            actionsContainer.appendChild(likeBtn);
            
            const dislikeBtn = document.createElement('button');
            dislikeBtn.className = `action-btn feedback-btn p-1.5 rounded-md hover:bg-[var(--bg3)] transition-all ${feedback === 'disliked' ? 'disliked' : ''}`;
            dislikeBtn.title = 'Dislike';
            dislikeBtn.innerHTML = '<i class="fa-regular fa-thumbs-down"></i>';
            dislikeBtn.onclick = (e) => { e.stopPropagation(); handleFeedback(index, 'disliked', likeBtn, dislikeBtn); };
            actionsContainer.appendChild(dislikeBtn);
        }

        const copyBtn = document.createElement('button');
        copyBtn.className = 'action-btn p-1.5 rounded-md hover:bg-[var(--bg3)] transition-all';
        copyBtn.title = 'Copy';
        copyBtn.innerHTML = '<i class="fa-regular fa-clipboard"></i>';
        copyBtn.onclick = (e) => {
            e.stopPropagation();
            navigator.clipboard.writeText(text);
            copyBtn.innerHTML = '<i class="fa-solid fa-check text-green-400"></i>';
            setTimeout(() => { copyBtn.innerHTML = '<i class="fa-regular fa-clipboard"></i>'; }, 1500);
        };
        actionsContainer.appendChild(copyBtn);

        bubble.appendChild(headerDiv);
        bubble.appendChild(textContentDiv);
        bubble.appendChild(actionsContainer);
        
        const bubbleOuter = bubble.outerHTML;
        messageInner.innerHTML = role === 'user' ? `<div class="flex-grow"></div>${bubbleOuter}${avatar}` : `${avatar}${bubbleOuter}<div class="flex-grow"></div>`;
        
        messageContainer.appendChild(messageInner);
        el.chatHistory.appendChild(messageContainer);
        scrollToBottom();

        if (save && !isError) {
            const messageToSave = { role, text };
            if (duration) messageToSave.duration = duration;
            activeChat.history.push(messageToSave);
            saveChats();
        }
    }
    
    function getCurrentDateTime() {
        return new Date().toLocaleString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    function buildPrompt() {
        const activeChat = state.chats.find(c => c.id === state.activeChatId);
        if (!activeChat) return "";

        const enhancedSystemPrompt = `Current date and time: ${getCurrentDateTime()}.\n${activeChat.system_prompt}\n\nAlways provide a helpful and direct response to the user's latest message.`;

        let formattedPrompt = `<|system|>\n${enhancedSystemPrompt}</s>\n`;
        activeChat.history.forEach(msg => {
            if (msg.role === 'user') {
                formattedPrompt += `<|user|>\n${msg.text}</s>\n`;
            } else if (msg.role === 'assistant') {
                formattedPrompt += `<|assistant|>\n${msg.text}</s>\n`;
            }
        });
        formattedPrompt += `<|assistant|>\n`;
        return formattedPrompt;
    }
    
    function scrollToBottom() { el.chatHistory.scrollTop = el.chatHistory.scrollHeight; }

    async function checkServerStatus() {
        updateStatus('connecting', 'Connecting to AI Server...');
        try {
            const response = await fetch(HUGGING_FACE_URL, { method: 'GET', signal: AbortSignal.timeout(15000) });
            if (response.ok) {
                const data = await response.json();
                if (data.status === 'AI server is online') {
                    updateStatus('connected', 'AI Server Online');
                    el.promptInput.disabled = false;
                    el.sendBtn.disabled = false;
                } else {
                    throw new Error('Unexpected server response');
                }
            } else {
                 throw new Error(`Server sleeping or offline (Status: ${response.status})`);
            }
        } catch (error) {
            updateStatus('failed', `Connection Failed. Server may be waking up. Refresh in a minute.`);
            console.error(error);
        }
    }
    
    function setGenerating(on) {
        state.isGenerating = on;
        el.promptInput.disabled = on;
        el.sendBtn.disabled = on;
        
        if (on) {
            el.sendBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
            let thinkingTime = 0;
            updateStatus('generating', `Assistant is thinking... (0.0s)`);
            state.generationTimer = setInterval(() => {
                thinkingTime += 100;
                el.statusText.textContent = `Assistant is thinking... (${(thinkingTime/1000).toFixed(1)}s)`;
            }, 100);
        } else {
            clearInterval(state.generationTimer);
            el.sendBtn.innerHTML = '<i class="fa-solid fa-arrow-up"></i>';
            updateStatus('connected', 'AI Server Online');
        }
    }
    
    async function getAiResponse() {
        const startTime = Date.now();
        setGenerating(true);
        state.abortController = new AbortController();
        const prompt = buildPrompt();
        const activeChat = state.chats.find(c => c.id === state.activeChatId);
        let duration = 0;

        try {
            const res = await fetch(`${HUGGING_FACE_URL}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt: prompt,
                    model: activeChat.model
                }),
                signal: state.abortController.signal
            });
            if (!res.ok) throw new Error(`Request failed: ${res.statusText} (${res.status})`);
            
            const data = await res.json();
            duration = Date.now() - startTime;
            return { success: true, response: data.response, duration: duration };

        } catch (e) {
            if (e.name === 'AbortError') {
                return { success: false, response: 'Request cancelled by user.' };
            }
            return { success: false, response: `An error occurred: ${e.message}. Please try again.` };
        } finally {
            setGenerating(false);
        }
    }

    function autoResizeTextarea() {
        el.promptInput.style.height = 'auto';
        const newHeight = Math.min(el.promptInput.scrollHeight, 200);
        el.promptInput.style.height = `${newHeight}px`;
    }
    
    function updateStatus(status, text) {
        const statusMap = {
            connecting: { color: 'bg-yellow-500', pulse: true },
            connected: { color: 'bg-green-500', pulse: false },
            generating: { color: 'bg-blue-500', pulse: true },
            failed: { color: 'bg-[var(--danger)]', pulse: false }
        };
        const newStatus = statusMap[status];

        el.statusText.textContent = text;
        el.statusDot.className = `w-2 h-2 rounded-full ${newStatus.color}`;
        newStatus.pulse ? el.statusDot.classList.add('animate-pulse') : el.statusDot.classList.remove('animate-pulse');
    }

    async function handleSend() {
        const promptText = el.promptInput.value.trim();
        if (!promptText || state.isGenerating) return;

        addMessage('user', promptText, {}, true);

        const activeChat = state.chats.find(c => c.id === state.activeChatId);
        if (activeChat.history.filter(m => m.role === 'user').length === 1) {
            activeChat.name = promptText.substring(0, 25).trim() + (promptText.length > 25 ? '...' : '');
            renderChatList();
            el.chatTitle.textContent = activeChat.name;
        }
        
        el.promptInput.value = '';
        autoResizeTextarea();

        const result = await getAiResponse();
        if (result.success) {
            addMessage('assistant', result.response, { index: activeChat.history.length, duration: result.duration }, true);
        } else {
            addMessage('assistant', result.response, { isError: true }, false);
        }
    }
    
    async function handleRegenerate(messageIndex) {
        if (state.isGenerating) return;
        const chat = state.chats.find(c => c.id === state.activeChatId);
        if (!chat) return;

        chat.history = chat.history.slice(0, messageIndex);
        saveChats();
        selectChat(chat.id);

        const result = await getAiResponse();
        if (result.success) {
            addMessage('assistant', result.response, { index: chat.history.length, duration: result.duration }, true);
        } else {
            addMessage('assistant', result.response, { isError: true }, false);
        }
    }
    
    function handleFeedback(messageIndex, feedback, likeBtn, dislikeBtn) {
        const chat = state.chats.find(c => c.id === state.activeChatId);
        if (!chat || !chat.history[messageIndex]) return;

        const message = chat.history[messageIndex];
        
        if (message.feedback === feedback) {
            message.feedback = null;
            likeBtn.classList.remove('liked');
            dislikeBtn.classList.remove('disliked');
        } else {
            message.feedback = feedback;
            likeBtn.classList.toggle('liked', feedback === 'liked');
            dislikeBtn.classList.toggle('disliked', feedback === 'disliked');
        }
        
        saveChats();
    }

    function addEventListeners() {
        el.sendBtn.onclick = () => {
            if (state.isGenerating) {
                state.abortController?.abort();
            } else {
                handleSend();
            }
        };
        el.promptInput.addEventListener('input', autoResizeTextarea);
        el.promptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }});
        el.themeBtn.onclick = () => { state.theme = state.theme === 'dark' ? 'light' : 'dark'; applyTheme(); };
        el.newChatBtn.onclick = () => { const newChat = createNewChat(); selectChat(newChat.id); };
        el.searchInput.oninput = e => renderChatList(e.target.value);
        el.chatList.onclick = e => { const id = e.target.closest('.sidebar-item')?.dataset.chatId; if(id) selectChat(parseInt(id)); };
        
        el.chatList.oncontextmenu = e => {
            e.preventDefault();
            const target = e.target.closest('.sidebar-item');
            if (!target) return;
            state.contextMenuChatId = parseInt(target.dataset.chatId);
            el.contextMenu.style.top = `${e.clientY}px`;
            el.contextMenu.style.left = `${e.clientX}px`;
            el.contextMenu.style.display = 'block';
        };

        el.renameChatBtn.onclick = () => {
            const chatToRename = state.chats.find(c => c.id === state.contextMenuChatId);
            if (!chatToRename) return;
            const newName = prompt('Enter new chat name:', chatToRename.name);
            if (newName && newName.trim()) { 
                chatToRename.name = newName.trim(); 
                saveChats(); 
                renderChatList(); 
                if (chatToRename.id === state.activeChatId) {
                    el.chatTitle.textContent = newName.trim(); 
                }
            }
            el.contextMenu.style.display = 'none';
        };

        el.deleteChatBtn.onclick = () => {
            if (confirm('Are you sure you want to delete this chat?')) {
                state.chats = state.chats.filter(c => c.id !== state.contextMenuChatId);
                saveChats();
                if (state.activeChatId === state.contextMenuChatId) {
                    selectChat(state.chats[0]?.id || null);
                }
                renderChatList();
            }
            el.contextMenu.style.display = 'none';
        };
        
        el.clearHistoryBtn.onclick = () => {
            if (!state.activeChatId) return;
            if (confirm('Are you sure you want to clear the history for this chat? This cannot be undone.')) {
                const chat = state.chats.find(c => c.id === state.activeChatId);
                if (chat) { chat.history = []; saveChats(); selectChat(state.activeChatId); }
            }
        };

        document.addEventListener('click', () => { if (el.contextMenu.style.display === 'block') el.contextMenu.style.display = 'none'; });

        el.systemPromptInput.oninput = () => {
            const chat = state.chats.find(c => c.id === state.activeChatId);
            if(chat) { 
                chat.system_prompt = el.systemPromptInput.value; 
                chat.persona = 'custom'; 
                el.personaSelect.value = 'custom'; 
                saveChats(); 
            }
        };
        
        el.personaSelect.onchange = () => {
            const personaKey = el.personaSelect.value;
            const chat = state.chats.find(c => c.id === state.activeChatId);
            if(chat && personaKey !== 'custom') { 
                chat.persona = personaKey; 
                chat.system_prompt = PERSONAS[personaKey].prompt; 
                el.systemPromptInput.value = chat.system_prompt; 
                saveChats(); 
            }
        };

        el.modelSelect.onchange = () => {
            const chat = state.chats.find(c => c.id === state.activeChatId);
            if(chat) {
                chat.model = el.modelSelect.value;
                saveChats();
            }
        };

        el.toggleLeftSidebar.onclick = () => { el.leftSidebar.classList.toggle('w-72'); el.leftSidebar.classList.toggle('w-0'); el.leftSidebar.classList.toggle('p-4'); el.leftSidebar.classList.toggle('p-0'); };
        el.toggleRightSidebar.onclick = () => { el.rightSidebar.classList.toggle('hidden'); };

        el.quickPromptsBtn.onclick = () => el.quickPromptsModal.classList.remove('hidden');
        el.modalCloseX.onclick = () => el.quickPromptsModal.classList.add('hidden');
        el.quickPromptsModal.onclick = (e) => { if (e.target === el.quickPromptsModal) el.quickPromptsModal.classList.add('hidden'); };
    }
    
    init();
});
</script>
</body>
</html>
